From 9aa203734086804b250b5c7e96723de288d7e8f5 Mon Sep 17 00:00:00 2001
From: Sven Neumann <neumann@teufel.de>
Date: Fri, 2 Oct 2015 16:19:44 +0200
Subject: [PATCH 3/6] connman: fix a potential crash

cm_service_add() creates a CMService struct with a NULL
service_proxy field and then uses the asynchronous
g_dbus_proxy_new_for_bus() to create the proxy. So the
service_proxy may be NULL when cm_service_free() is called
before the proxy is actually created.
---
 libgupnp/gupnp-connman-manager.c | 18 ++++++++++--------
 1 file changed, 10 insertions(+), 8 deletions(-)

diff --git a/libgupnp/gupnp-connman-manager.c b/libgupnp/gupnp-connman-manager.c
index c8f1ba6..22fa8a5 100644
--- a/libgupnp/gupnp-connman-manager.c
+++ b/libgupnp/gupnp-connman-manager.c
@@ -268,17 +268,19 @@ cm_service_new (GUPnPConnmanManager *manager,
 static void
 cm_service_free (CMService *cm_service)
 {
-        GDBusConnection *cnx;
+        if (cm_service->proxy != NULL) {
+                GDBusConnection *cnx;
 
-        cnx = g_dbus_proxy_get_connection (cm_service->proxy);
+                cnx = g_dbus_proxy_get_connection (cm_service->proxy);
 
-        if (cm_service->sig_prop_id) {
-                g_dbus_connection_signal_unsubscribe (cnx,
-                                                      cm_service->sig_prop_id);
-                cm_service->sig_prop_id = 0;
-        }
+                if (cm_service->sig_prop_id) {
+                        g_dbus_connection_signal_unsubscribe (cnx,
+                                                              cm_service->sig_prop_id);
+                        cm_service->sig_prop_id = 0;
+                }
 
-        g_object_unref (cm_service->proxy);
+                g_object_unref (cm_service->proxy);
+        }
 
         service_context_remove_creation_timeout (cm_service);
 
-- 
2.4.3

