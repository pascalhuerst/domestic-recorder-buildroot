From 50d41159e28e1b786022faf4cfba37bbb70a12de Mon Sep 17 00:00:00 2001
From: Max Blagay <max.blagaj@gmail.com>
Date: Fri, 10 Oct 2014 14:23:40 +0200
Subject: [PATCH] id3V2_vs_id3V1

---
 taglib/mpeg/mpegfile.cpp       | 18 +++++-----
 taglib/mpeg/mpegproperties.cpp | 74 +++++++++++++++++++++---------------------
 2 files changed, 47 insertions(+), 45 deletions(-)

diff --git a/taglib/mpeg/mpegfile.cpp b/taglib/mpeg/mpegfile.cpp
index f765bef..9b85a9f 100644
--- a/taglib/mpeg/mpegfile.cpp
+++ b/taglib/mpeg/mpegfile.cpp
@@ -480,14 +480,16 @@ void MPEG::File::read(bool readProperties, Properties::ReadStyle propertiesStyle
     else
       d->hasID3v2 = true;
   }
-
-  // Look for an ID3v1 tag
-
-  d->ID3v1Location = findID3v1();
-
-  if(d->ID3v1Location >= 0) {
-    d->tag.set(ID3v1Index, new ID3v1::Tag(this, d->ID3v1Location));
-    d->hasID3v1 = true;
+  else
+  {
+    // Look for an ID3v1 tag
+    
+    d->ID3v1Location = findID3v1();
+    
+    if(d->ID3v1Location >= 0) {
+      d->tag.set(ID3v1Index, new ID3v1::Tag(this, d->ID3v1Location));
+      d->hasID3v1 = true;
+    }
   }
 
   // Look for an APE tag
diff --git a/taglib/mpeg/mpegproperties.cpp b/taglib/mpeg/mpegproperties.cpp
index 3af9566..e1dac97 100644
--- a/taglib/mpeg/mpegproperties.cpp
+++ b/taglib/mpeg/mpegproperties.cpp
@@ -148,56 +148,57 @@ bool MPEG::Properties::isOriginal() const
 
 void MPEG::Properties::read()
 {
-  // Since we've likely just looked for the ID3v1 tag, start at the end of the
-  // file where we're least likely to have to have to move the disk head.
-
-  long last = d->file->lastFrameOffset();
-
-  if(last < 0) {
-    debug("MPEG::Properties::read() -- Could not find a valid last MPEG frame in the stream.");
-    return;
-  }
-
-  d->file->seek(last);
-  Header lastHeader(d->file->readBlock(4));
-
   long first = d->file->firstFrameOffset();
+  long last = d->file->lastFrameOffset();
 
   if(first < 0) {
     debug("MPEG::Properties::read() -- Could not find a valid first MPEG frame in the stream.");
     return;
   }
 
-  if(!lastHeader.isValid()) {
-
-    long pos = last;
-
-    while(pos > first) {
+  // Now jump back to the front of the file and read what we need from there.
 
-      pos = d->file->previousFrameOffset(pos);
+  d->file->seek(first);
+  Header firstHeader(d->file->readBlock(4));
 
-      if(pos < 0)
-        break;
+  if(!firstHeader.isValid()) {
+    last = d->file->lastFrameOffset();
 
-      d->file->seek(pos);
-      Header header(d->file->readBlock(4));
+    if(last < 0) {
+      debug("MPEG::Properties::read() -- Could not find a valid last MPEG frame in the stream.");
+      return;
+    }
 
-      if(header.isValid()) {
-        lastHeader = header;
-        last = pos;
-        break;
+    d->file->seek(last);
+    Header lastHeader(d->file->readBlock(4));
+
+    if(!lastHeader.isValid()) {
+      
+      long pos = last;
+      
+      while(pos > first) {
+	
+	pos = d->file->previousFrameOffset(pos);
+	
+	if(pos < 0)
+	  break;
+
+	d->file->seek(pos);
+	Header header(d->file->readBlock(4));
+	
+	if(header.isValid()) {
+	  lastHeader = header;
+	  last = pos;
+	  break;
+	}
       }
     }
-  }
 
-  // Now jump back to the front of the file and read what we need from there.
-
-  d->file->seek(first);
-  Header firstHeader(d->file->readBlock(4));
-
-  if(!firstHeader.isValid() || !lastHeader.isValid()) {
-    debug("MPEG::Properties::read() -- Page headers were invalid.");
-    return;
+    if(!lastHeader.isValid())
+    {
+      debug("MPEG::Properties::read() -- Page headers were invalid.");
+      return;
+    }
   }
 
   // Check for a Xing header that will help us in gathering information about a
@@ -242,7 +243,6 @@ void MPEG::Properties::read()
     }
   }
 
-
   d->sampleRate = firstHeader.sampleRate();
   d->channels = firstHeader.channelMode() == Header::SingleChannel ? 1 : 2;
   d->version = firstHeader.version();
-- 
1.9.1

