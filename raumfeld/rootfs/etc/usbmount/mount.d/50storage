#!/bin/sh

# Check if this is the master device
grep "^ismaster=yes" /var/raumfeld-1.0/master-process.conf || exit 0

# Check for disk UUID and label
uuid=`/lib/udev/vol_id $UM_DEVICE --uuid`
label=`/lib/udev/vol_id $UM_DEVICE --label`

if test -z "$label"; then
  # If there's no label, use vendor and/or model

  if test -n "$UM_VENDOR"; then
    label="$UM_VENDOR $UM_MODEL"
  elif test -n "$UM_MODEL"; then
    label="$UM_MODEL"
  else
    label="USB Storage"
  fi
fi

i=3
while [ $i -gt 0 ]; do
    /usr/bin/raumfeld-prefs \
        "set-value /Preferences/Storages Storage $uuid Path file://$UM_MOUNTPOINT" \
        "set-value /Preferences/Storages Storage $uuid Online 1" \
        "set-value /Preferences/Storages Storage $uuid Name $label" \
        "store" && break
    i=`expr $i - 1`
    echo "raumfeld-prefs failed. Trying $i more times."
done
