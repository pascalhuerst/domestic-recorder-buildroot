#!/bin/sh

. ../tests.inc
TITLE="HARDDISK"
DIALOGOPTS="--title $TITLE"

DEV=/dev/hda
TMPROOT=/tmp/root

# enable 32bit access
hdparm -c1 -d1 -p4 ${DEV}

# purge partition table, if any. This script does it the hard way.
dd if=/dev/zero of=$DEV bs=512 count=1

# create a new one
sfdisk $DEV << __EOF__
0,8
,300
;
;
__EOF__

for x in 1 2 3; do
	echo "****** Creating filesystem $x/3. ******"
	mkfs.ext3 ${DEV}${x}
done

mkdir $TMPROOT
mount -t ext3 ${DEV}2 $TMPROOT

mkdir $TMPROOT/boot
mount -t ext3 ${DEV}1 $TMPROOT/boot

if [ -z "$(mount | grep $TMPROOT)" ]; then
	touch /tmp/hdd-failed
	exit
fi

zcat /rootfs.tgz | tar -f - -C $TMPROOT -xv | \
	/percent `cat /rootfs.tgz.numfiles` | \
	dialog_progress "Copying files to harddisk. Please wait." $DIALOGOPTS

chmod 0755 $TMPROOT
umount $TMPROOT/boot
umount $TMPROOT

